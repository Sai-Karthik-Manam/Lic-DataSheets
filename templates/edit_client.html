<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Client Documents | LIC Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 15px;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
      font-size: 24px;
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      transition: color 0.3s;
    }

    .modal-close-btn:hover {
      color: #dc3545;
    }

    .edit-doc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .edit-doc-card {
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      border: 2px solid #dee2e6;
      transition: all 0.3s ease;
    }

    .edit-doc-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .doc-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .doc-card-icon {
      font-size: 20px;
    }

    .doc-status {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
    }

    .status-exists {
      background: #d4edda;
      color: #155724;
    }

    .status-empty {
      background: #f8d7da;
      color: #721c24;
    }

    .doc-preview {
      width: 100%;
      height: 120px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .doc-preview:hover {
      transform: scale(1.05);
    }

    .doc-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .doc-preview-empty {
      color: #999;
      font-size: 40px;
    }

    .doc-preview-text {
      color: #666;
      font-size: 12px;
      text-align: center;
    }

    .doc-actions-modal {
      display: flex;
      gap: 8px;
      flex-direction: column;
    }

    .btn-upload-doc {
      padding: 10px 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-upload-doc:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-remove-doc {
      padding: 8px 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: none;
    }

    .btn-remove-doc.show {
      display: block;
    }

    .btn-remove-doc:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .file-input-modal {
      display: none;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
      justify-content: flex-end;
      border-top: 1px solid #dee2e6;
      padding-top: 20px;
    }

    .btn-modal-save {
      padding: 12px 25px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-modal-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }

    .btn-modal-cancel {
      padding: 12px 25px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-modal-cancel:hover {
      background: #5a6268;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #667eea;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .success-message {
      padding: 12px 16px;
      background: #d4edda;
      color: #155724;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }

    .success-message.show {
      display: block;
      animation: slideIn 0.3s ease;
    }
  </style>
</head>
<body>

<!-- Edit Client Modal -->
<div class="modal-overlay" id="editClientModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Client Documents</h2>
      <button class="modal-close-btn" onclick="closeEditModal()">‚úï</button>
    </div>

    <div class="success-message" id="successMessage">
      ‚úÖ Documents updated successfully!
    </div>

    <form id="editDocumentsForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="client_id" id="clientIdInput">

      <div class="edit-doc-grid" id="editDocGrid">
        <!-- Documents will be dynamically loaded here -->
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-modal-cancel" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-modal-save" id="saveDocsBtn">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
let selectedFiles = {};

function openEditModal(clientId, clientName) {
  const modal = document.getElementById('editClientModal');
  document.getElementById('clientIdInput').value = clientId;
  
  // Fetch current documents
  fetch(`/api/client/${clientId}/documents`)
    .then(response => response.json())
    .then(data => {
      renderDocumentsEditGrid(data.documents);
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    })
    .catch(error => {
      alert('‚ùå Error loading documents: ' + error.message);
    });
}

function closeEditModal() {
  const modal = document.getElementById('editClientModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  selectedFiles = {};
  document.getElementById('editDocumentsForm').reset();
}

function renderDocumentsEditGrid(documents) {
  const grid = document.getElementById('editDocGrid');
  grid.innerHTML = '';

  const docTypes = [
    { key: 'datasheet', icon: 'üìä', name: 'Datasheet' },
    { key: 'aadhaar', icon: 'ü™™', name: 'Aadhaar Card' },
    { key: 'pan', icon: 'üí≥', name: 'PAN Card' },
    { key: 'bank_account', icon: 'üè¶', name: 'Bank Account' }
  ];

  docTypes.forEach(doc => {
    const existing = documents[doc.key];
    const hasDoc = existing ? true : false;

    const card = document.createElement('div');
    card.className = 'edit-doc-card';
    card.innerHTML = `
      <div class="doc-card-title">
        <span class="doc-card-icon">${doc.icon}</span>
        ${doc.name}
      </div>

      <div class="doc-status ${hasDoc ? 'status-exists' : 'status-empty'}">
        ${hasDoc ? '‚úÖ Document Exists' : '‚ö†Ô∏è No Document'}
      </div>

      <div class="doc-preview" onclick="triggerFileInput('${doc.key}')">
        ${hasDoc 
          ? `<img src="${existing.url}" alt="${doc.name}" onerror="this.parentElement.innerHTML='<div class=\"doc-preview-empty\">üìÑ</div>'">` 
          : '<div class="doc-preview-empty">+</div>'}
      </div>

      <div class="doc-preview-text">
        ${hasDoc ? 'Click to replace or use button below' : 'Click to upload new document'}
      </div>

      <div class="doc-actions-modal">
        <button type="button" class="btn-upload-doc" onclick="triggerFileInput('${doc.key}')">
          üì§ ${hasDoc ? 'Replace' : 'Upload'}
        </button>
        ${hasDoc ? `<button type="button" class="btn-remove-doc show" onclick="removeDocument('${doc.key}')">üóëÔ∏è Remove</button>` : ''}
      </div>

      <input type="file" class="file-input-modal" id="fileInput_${doc.key}" 
             accept="image/*,application/pdf" 
             onchange="handleFileSelect('${doc.key}', this)">
    `;

    grid.appendChild(card);
  });
}

function triggerFileInput(docType) {
  document.getElementById(`fileInput_${docType}`).click();
}

function handleFileSelect(docType, input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];

    // Validate file size
    if (file.size > 10 * 1024 * 1024) {
      alert('‚ùå File too large! Maximum size is 10MB.');
      input.value = '';
      return;
    }

    // Store file
    selectedFiles[docType] = file;

    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = input.parentElement.querySelector('.doc-preview');
      if (file.type.startsWith('image/')) {
        preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
      } else {
        preview.innerHTML = '<div class="doc-preview-empty">üìÑ PDF</div>';
      }

      // Update status
      const status = input.parentElement.querySelector('.doc-status');
      status.textContent = 'üîÑ Ready to upload';
      status.className = 'doc-status';
      status.style.background = '#fff3cd';
      status.style.color = '#856404';
    };
    reader.readAsDataURL(file);
  }
}

function removeDocument(docType) {
  if (confirm(`‚ùå Remove ${docType}?`)) {
    selectedFiles[docType] = 'DELETE';
    const input = document.getElementById(`fileInput_${docType}`);
    const status = input.parentElement.querySelector('.doc-status');
    status.textContent = 'üóëÔ∏è Will be removed';
    status.className = 'doc-status';
    status.style.background = '#f8d7da';
    status.style.color = '#721c24';
  }
}

document.getElementById('editDocumentsForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  if (Object.keys(selectedFiles).length === 0) {
    alert('‚ö†Ô∏è Please select at least one document to upload or modify.');
    return;
  }

  const saveBtn = document.getElementById('saveDocsBtn');
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="loading-spinner"></span>Saving...';

  const formData = new FormData();
  const clientId = document.getElementById('clientIdInput').value;
  formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);

  // Add files to form data
  Object.keys(selectedFiles).forEach(docType => {
    if (selectedFiles[docType] === 'DELETE') {
      formData.append(`delete_${docType}`, 'true');
    } else if (selectedFiles[docType] instanceof File) {
      formData.append(docType, selectedFiles[docType]);
    }
  });

  try {
    const response = await fetch(`/api/client/${clientId}/update-documents`, {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (data.success) {
      const successMsg = document.getElementById('successMessage');
      successMsg.classList.add('show');
      setTimeout(() => {
        successMsg.classList.remove('show');
        closeEditModal();
        location.reload();
      }, 2000);
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  } catch (error) {
    alert('‚ùå Error updating documents: ' + error.message);
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = 'Save Changes';
  }
});

// Close modal on escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeEditModal();
  }
});

// Close modal on outside click
document.getElementById('editClientModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditModal();
  }
});
</script>

</body>
</html>